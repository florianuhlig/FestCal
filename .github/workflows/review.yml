name: Review

on:
    push:
        branches: [review]
        paths:
            - "src/**"
            - "tests/**"
            - "requirements.txt"
            - "pyproject.toml"

permissions:
    contents: write

jobs:
    lint:
        name: Lint & Format Check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install black isort flake8 pylint

            - name: Check formatting with black
              run: black --check --diff src/ tests/

            - name: Check import sorting with isort
              run: isort --check-only --diff src/ tests/

            - name: Lint with flake8
              run: |
                  flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
                  flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

            - name: Lint with pylint
              run: pylint src/ --exit-zero --max-line-length=100

    merge-to-testing:
        name: Merge to Testing
        needs: lint
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Merge review into testing
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git fetch origin testing || true
                  if git show-ref --verify --quiet refs/remotes/origin/testing; then
                    git checkout testing
                    git merge origin/review --no-edit
                  else
                    git checkout -b testing
                  fi
                  git push origin testing

    run-tests:
        name: Run Tests
        needs: merge-to-testing
        uses: ./.github/workflows/testing.yml
